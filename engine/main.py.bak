import os
import sys
import time
from .config import load_config, save_config
from .state import GameState, save_game, load_game, list_saves
from .ui import clear_screen, type_text, prompt_choice, prompt_save, prompt_load, prompt_settings
from .actions import perform_actions, _normalize_target
from .conditions import check_conditions
from .story_loader import load_story

def run(start_scene="prologue.start"):
    """–ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã."""
    story = load_story()
    gs = GameState(start_scene)

    # === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ ===
    config = load_config()
    save_dir = config.get("save_dir", "saves")
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
    save_files = []
    if os.path.exists(save_dir):
        save_files = [f for f in os.listdir(save_dir) if f.endswith(('.json', '.dat'))]
    
    if save_files:
        ans = input("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ? (y/n): ").lower().strip()
        if ans == "y":
            if loaded := prompt_load():
                gs = loaded

    while True:
        scene = story.get(gs.current)
        if not scene:
            print(f"[–û—à–∏–±–∫–∞: —Å—Ü–µ–Ω–∞ {gs.current} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞]")
            # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Å—Ü–µ–Ω—É
            fallback_scene = gs.current.split('.')[0] + '.start'
            if fallback_scene in story and fallback_scene != gs.current:
                print(f"[–ü–µ—Ä–µ—Ö–æ–¥ –∫ {fallback_scene}]")
                gs.current = fallback_scene
                continue
            return

        # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç None
        conditions = scene.get("conditions")
        if not check_conditions(gs, conditions):
            print(f"[–£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–ª—è {gs.current}]")
            # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å
            if "fallback" in scene:
                gs.current = _normalize_target(gs, scene["fallback"])
                continue
            return

        clear_screen()
        print(f"--- {gs.current} ---\n")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        text = scene.get("text")
        if text:
            type_text(text + "\n")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ü–µ–Ω—É –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        previous_scene = gs.current

        # –í–´–ü–û–õ–ù–Ø–ï–ú –î–ï–ô–°–¢–í–ò–Ø (–≤–∫–ª—é—á–∞—è jump)
        perform_actions(gs, scene.get("actions", []))

        # –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π (–±—ã–ª jump), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª —Å –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã
        if gs.current != previous_scene:
            continue

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        choices = [
            ch for ch in scene.get("choices", [])
            if check_conditions(gs, ch.get("conditions"))
        ]

        if not choices:
            print("\n(–ö–æ–Ω–µ—Ü —Å—Ü–µ–Ω—ã)")
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±–æ—Ä–æ–≤
            if "auto_next" in scene:
                gs.current = _normalize_target(gs, scene["auto_next"])
                continue
            return

        user_input = prompt_choice(choices)

        # -------------------------------
        # üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º/–∑–∞–≥—Ä—É–∑–∫–æ–π/–≤—ã—Ö–æ–¥–æ–º
        # -------------------------------
        if user_input == "s":
            prompt_settings()
            input("Enter -> –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ")
            continue
        elif user_input == "v":
            prompt_save(gs)
            input("Enter -> –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ")
            continue
        elif user_input == "l":
            if loaded := prompt_load():
                gs = loaded
                # –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã
                continue
            input("Enter -> –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ")
            continue
        elif user_input == "q":
            ans = input("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º? (y/n): ").lower()
            if ans == "y":
                prompt_save(gs)
            return

        # -------------------------------
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ü–µ–Ω—ã
        # -------------------------------
        try:
            idx = int(user_input) - 1
            if not (0 <= idx < len(choices)):
                raise ValueError
        except ValueError:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥.")
            time.sleep(0.5)
            continue

        selected = choices[idx]

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ü–µ–Ω—É –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤—ã–±–æ—Ä–∞
        previous_scene = gs.current
        perform_actions(gs, selected.get("actions", []))

        # –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π –≤—ã–±–æ—Ä–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª
        if gs.current != previous_scene:
            continue

        next_scene = selected.get("next") or selected.get("jump")
        if not next_scene:
            print("\n(–ö–æ–Ω–µ—Ü –ø—É—Ç–∏ ‚Äî –Ω–µ—Ç next/jump)")
            return

        gs.current = _normalize_target(gs, next_scene)
